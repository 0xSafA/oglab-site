# Agent Spec — OG Lab AI Budtender

Описание архитектуры агента, его промптов, бизнес-правил и ссылок на код.

## 1) Цели и роль агента

- Дружелюбный будтендер: собирает потребности, рекомендует продукты, делает апселл
- Управляет оформлением заказов: собирает 5 пунктов данных и уведомляет персонал
- Многоязычность: автоматически отвечает на языке пользователя

## 2) Архитектура потока (веб/телеграм)

```
User → /api/agent/chat → OpenAI (SSE) → Extract products → Detect intent → (optional) /api/telegram/notify → Reply stream
```

- Вебхук Telegram описан в `docs/telegram.md`
- Кэширование меню/контекста — см. `docs/redis.md`

## 3) Основные файлы и ссылки на код

- API входная точка: `src/app/api/agent/chat/route.ts`
  - SSE стрим, извлечение продуктов, построение карточек, intent → notify
- Хелперы агента (промпты и логика): `src/lib/agent-helpers.ts`
  - `buildSystemPrompt(...)` — системный промпт c правилами и миссией
  - `buildMenuContext(...)` — компактный контекст склада (цветы/концентраты)
  - `extractProductMentions(...)` — извлечение упоминаний продуктов
  - `extractOrderInfo(...)` — извлечение структурированных данных заказа
  - `calculateOrderTotal(...)` — расчёт суммы заказа и брейкдаун
  - `shouldIncludeConcentrates(...)` — эвристика по концентратам
  - `detectLanguage(...)` — определение языка
- Диалоги и профили: `src/lib/conversations-db.ts`, `src/lib/user-profile-db.ts`
- Аналитика и события: `src/lib/analytics-db.ts`
- Семантический кэш: `src/lib/semantic-cache.ts`
- Кэш Redis/ключи/TTL: `src/lib/redis-client.ts`

## 4) Промпт: ключевые правила (в `buildSystemPrompt`)

- Собирать по порядку 5 полей для заказа: продукт, количество, телефон, адрес, оплата
- Минимальный вес: ≥20г для цветка, ≥10г для хэша
- Язык ответа = язык пользователя; без эмодзи; кратко и по делу
- По умолчанию предлагать цветы; концентраты → при запросе/уместном апселле
- Имена продуктов — строго как в складе (для карточек и цен)

## 5) Решение об уведомлении персонала (Intent)

Реализация: `detectUserIntent(...)` внутри `src/app/api/agent/chat/route.ts`

- Типы: `order`, `wish`, `staff_question`, `feedback`, `general`
- `order` отправляется только когда собраны все 5 полей и выполнен минимум веса
- Остальные типы отправляются по контексту (желание, вопрос к персоналу, фидбек)
- Матрица триггеров: см. `docs/system_architecture.md` (Telegram Decision Matrix)

## 6) Карточки продуктов

- Строятся после ответа модели на основе `extractProductMentions` + данных меню
- Поля карточки: name, category, type, THC/CBG, цены 1g/5g/20g, isOur, effects, flavors

## 7) Кэширование и производительность

- Меню/контекст: Redis → Memory → БД (см. `docs/redis.md`)
- Семантический кэш: быстрый путь для частых вопросов; auto-promotion в Redis
- Лимит истории: последние 12 сообщений для экономии токенов/скорости

## 8) Телеграм

- Канон: `docs/telegram.md`
- Notify API (встроен в telegram.md, §3.1)
- Переменные окружения и chat_id (telegram.md, §5)

## 9) Тестирование и отладка

- Проверка статуса агента: `GET /api/agent/chat` (возвращает инфо о кэше и модели)
- Проверка Whisper: `GET /api/agent/whisper`
- Логи: hit/miss Redis, intent/notify, ошибки OpenAI/Telegram

## 10) Будущее расширение

- Версионирование промпта (PROMPT_VERSION) и логирование версии в событиях
- A/B-тесты промпта; расширение intent-матрицы; FAQ-деревья
