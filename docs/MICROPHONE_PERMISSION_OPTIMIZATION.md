# üé§ –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è —Ä–∞–±–æ—Ç—ã —Å —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è–º–∏ –º–∏–∫—Ä–æ—Ñ–æ–Ω–∞

## –ü—Ä–æ–±–ª–µ–º–∞

–ë—Ä–∞—É–∑–µ—Ä –∫–∞–∂–¥—ã–π —Ä–∞–∑ –∑–∞–ø—Ä–∞—à–∏–≤–∞–ª —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ –Ω–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –º–∏–∫—Ä–æ—Ñ–æ–Ω–∞ –ø—Ä–∏ –∫–∞–∂–¥–æ–º –Ω–∞–∂–∞—Ç–∏–∏ –∫–Ω–æ–ø–∫–∏ –≥–æ–ª–æ—Å–æ–≤–æ–≥–æ –≤–≤–æ–¥–∞, –¥–∞–∂–µ –µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–∂–µ –¥–∞–≤–∞–ª —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ —Ä–∞–Ω–µ–µ.

### –ü—Ä–∏—á–∏–Ω—ã:
1. **MediaStream –∑–∞–∫—Ä—ã–≤–∞–ª—Å—è –ø–æ—Å–ª–µ –∫–∞–∂–¥–æ–π –∑–∞–ø–∏—Å–∏** - –ø—Ä–∏ –≤—ã–∑–æ–≤–µ `stream.getTracks().forEach(track => track.stop())` –º—ã –ø–æ–ª–Ω–æ—Å—Ç—å—é –æ—Å–≤–æ–±–æ–∂–¥–∞–ª–∏ —Ä–µ—Å—É—Ä—Å—ã
2. **–ù–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å –ø—Ä–∏ –∫–∞–∂–¥–æ–º startRecording()** - –∫–∞–∂–¥—ã–π —Ä–∞–∑ –≤—ã–∑—ã–≤–∞–ª—Å—è `getUserMedia()` –±–µ–∑ –ø—Ä–æ–≤–µ—Ä–∫–∏ –Ω–∞–ª–∏—á–∏—è –∞–∫—Ç–∏–≤–Ω–æ–≥–æ stream
3. **–û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–π** - –Ω–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª—Å—è Permissions API –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å—Ç–∞—Ç—É—Å–∞

## –†–µ—à–µ–Ω–∏–µ

### 1. –ü–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ MediaStream

**–§–∞–π–ª:** `src/lib/audio-recorder.ts`

#### –î–æ–±–∞–≤–ª–µ–Ω–æ:
```typescript
private keepStreamAlive: boolean = true; // –°–æ—Ö—Ä–∞–Ω—è–µ–º stream –º–µ–∂–¥—É –∑–∞–ø–∏—Å—è–º–∏
```

#### –õ–æ–≥–∏–∫–∞ –≤ `startRecording()`:
```typescript
// –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ —É–∂–µ –∞–∫—Ç–∏–≤–Ω—ã–π stream (–ø–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º –¥–ª—è –∏–∑–±–µ–∂–∞–Ω–∏—è –ø–æ–≤—Ç–æ—Ä–Ω–æ–≥–æ –∑–∞–ø—Ä–æ—Å–∞)
if (!this.stream || !this.stream.active) {
  console.log('üé§ Requesting microphone access...');
  this.stream = await navigator.mediaDevices.getUserMedia({ ... });
  console.log('‚úÖ Microphone access granted');
} else {
  console.log('üì¶ Reusing existing microphone stream');
}
```

–¢–µ–ø–µ—Ä—å stream **–ù–ï –∑–∞–∫—Ä—ã–≤–∞–µ—Ç—Å—è** –ø–æ—Å–ª–µ –∫–∞–∂–¥–æ–π –∑–∞–ø–∏—Å–∏, –∞ –ø–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è!

### 2. Permissions API

–î–æ–±–∞–≤–ª–µ–Ω –º–µ—Ç–æ–¥ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å—Ç–∞—Ç—É—Å–∞ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è **–î–û** –∑–∞–ø—Ä–æ—Å–∞:

```typescript
static async checkMicrophonePermission(): Promise<'granted' | 'denied' | 'prompt'> {
  if (!navigator.permissions || !navigator.permissions.query) {
    return 'prompt'; // Safari iOS –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç
  }

  try {
    const result = await navigator.permissions.query({ name: 'microphone' });
    return result.state;
  } catch (error) {
    return 'prompt';
  }
}
```

### 3. –ü—Ä–∞–≤–∏–ª—å–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞ —Ä–µ—Å—É—Ä—Å–æ–≤

#### `cleanup()` - –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è –ø–æ—Å–ª–µ –∫–∞–∂–¥–æ–π –∑–∞–ø–∏—Å–∏
- **–ù–ï –∑–∞–∫—Ä—ã–≤–∞–µ—Ç** stream –µ—Å–ª–∏ `keepStreamAlive = true`
- –ó–∞–∫—Ä—ã–≤–∞–µ—Ç —Ç–æ–ª—å–∫–æ `MediaRecorder`

#### `destroy()` - –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è –ø—Ä–∏ —Ä–∞–∑–º–æ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞
- **–ü–æ–ª–Ω–æ—Å—Ç—å—é –æ—Å–≤–æ–±–æ–∂–¥–∞–µ—Ç** –≤—Å–µ —Ä–µ—Å—É—Ä—Å—ã –≤–∫–ª—é—á–∞—è stream
- –í—ã–∑—ã–≤–∞–µ—Ç—Å—è –≤ `useEffect` cleanup

```typescript
useEffect(() => {
  return () => {
    if (recorderRef.current) {
      recorderRef.current.destroy() // ‚Üê –ü–æ–ª–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞
    }
  }
}, [locale])
```

### 4. –í–∏–∑—É–∞–ª—å–Ω—ã–π –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è

**–§–∞–π–ª:** `src/components/OGLabAgent.tsx`

–î–æ–±–∞–≤–ª–µ–Ω state –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞:
```typescript
const [microphonePermission, setMicrophonePermission] = 
  useState<'granted' | 'denied' | 'prompt'>('prompt')
```

#### –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏:
```typescript
useEffect(() => {
  if (isSupported) {
    AudioRecorder.checkMicrophonePermission().then(permission => {
      setMicrophonePermission(permission)
      if (permission === 'granted') {
        console.log('‚úÖ Microphone permission already granted')
      }
    })
  }
}, [locale])
```

#### –í–∏–∑—É–∞–ª—å–Ω—ã–π –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä:
- üü¢ **–ó–µ–ª—ë–Ω–∞—è —Ç–æ—á–∫–∞** –≤ –ø—Ä–∞–≤–æ–º –≤–µ—Ä—Ö–Ω–µ–º —É–≥–ª—É –∫–Ω–æ–ø–∫–∏ –º–∏–∫—Ä–æ—Ñ–æ–Ω–∞
- **–ó–µ–ª—ë–Ω–∞—è –æ–±–≤–æ–¥–∫–∞** –∫–Ω–æ–ø–∫–∏ –∫–æ–≥–¥–∞ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ –¥–∞–Ω–æ
- –ü–æ—è–≤–ª—è–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –∫–æ–≥–¥–∞ `microphonePermission === 'granted'`

```tsx
{microphonePermission === 'granted' && recordingState === 'idle' && (
  <div 
    className="absolute rounded-full bg-green-500 -right-1 -top-1 h-2.5 w-2.5"
    title="–†–∞–∑—Ä–µ—à–µ–Ω–∏–µ –Ω–∞ –º–∏–∫—Ä–æ—Ñ–æ–Ω –¥–∞–Ω–æ"
  />
)}
```

## –†–µ–∑—É–ª—å—Ç–∞—Ç

### –î–æ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏:
- ‚ùå –ë—Ä–∞—É–∑–µ—Ä –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ—Ç —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ –ø—Ä–∏ –∫–∞–∂–¥–æ–º –Ω–∞–∂–∞—Ç–∏–∏
- ‚ùå Stream –∑–∞–∫—Ä—ã–≤–∞–µ—Ç—Å—è –ø–æ—Å–ª–µ –∫–∞–∂–¥–æ–π –∑–∞–ø–∏—Å–∏
- ‚ùå –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –≤–∏–¥–∏—Ç —Å—Ç–∞—Ç—É—Å —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è
- üò§ –†–∞–∑–¥—Ä–∞–∂–∞—é—â–∏–π UX

### –ü–æ—Å–ª–µ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏:
- ‚úÖ –†–∞–∑—Ä–µ—à–µ–Ω–∏–µ –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ—Ç—Å—è **—Ç–æ–ª—å–∫–æ –æ–¥–∏–Ω —Ä–∞–∑**
- ‚úÖ Stream –ø–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –º–µ–∂–¥—É –∑–∞–ø–∏—Å—è–º–∏
- ‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–∏–¥–∏—Ç –∑–µ–ª—ë–Ω—ã–π –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä
- ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–π —á–µ—Ä–µ–∑ Permissions API
- üéâ –ü–ª–∞–≤–Ω—ã–π UX –±–µ–∑ –ª–∏—à–Ω–∏—Ö –ø–æ–ø–∞–ø–æ–≤

## –°–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å —Å –±—Ä–∞—É–∑–µ—Ä–∞–º–∏

| –ë—Ä–∞—É–∑–µ—Ä | Permissions API | MediaStream reuse | –†–∞–±–æ—Ç–∞–µ—Ç |
|---------|-----------------|-------------------|----------|
| Chrome 90+ | ‚úÖ | ‚úÖ | ‚úÖ |
| Firefox 90+ | ‚úÖ | ‚úÖ | ‚úÖ |
| Safari 15+ | ‚ö†Ô∏è (—á–∞—Å—Ç–∏—á–Ω–æ) | ‚úÖ | ‚úÖ |
| Safari iOS | ‚ùå | ‚úÖ | ‚úÖ |
| Edge 90+ | ‚úÖ | ‚úÖ | ‚úÖ |

**–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ:** Safari iOS –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç Permissions API, –Ω–æ –ø–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ stream –≤—Å—ë —Ä–∞–≤–Ω–æ —Ä–∞–±–æ—Ç–∞–µ—Ç!

## –õ–æ–≥–∏ –≤ –∫–æ–Ω—Å–æ–ª–∏

### –ü–µ—Ä–≤–∞—è –∑–∞–ø–∏—Å—å (–Ω–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å):
```
üé§ Requesting microphone access...
‚úÖ Microphone access granted
‚úÖ Microphone permission already granted
```

### –ü–æ—Å–ª–µ–¥—É—é—â–∏–µ –∑–∞–ø–∏—Å–∏ (–ø–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ):
```
üì¶ Reusing existing microphone stream
```

### –ü—Ä–∏ —Ä–∞–∑–º–æ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞:
```
üîá Destroying microphone stream
```

## –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏

1. **HTTPS –æ–±—è–∑–∞—Ç–µ–ª–µ–Ω** - –±—Ä–∞—É–∑–µ—Ä—ã –Ω–µ –∑–∞–ø–æ–º–∏–Ω–∞—é—Ç —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è –Ω–∞ HTTP (–∫—Ä–æ–º–µ localhost)
2. **–ù–µ –∏–∑–º–µ–Ω—è–π—Ç–µ `keepStreamAlive`** - —ç—Ç–æ –æ–ø—Ç–∏–º–∞–ª—å–Ω–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞
3. **–¢–µ—Å—Ç–∏—Ä—É–π—Ç–µ –Ω–∞ —Ä–∞–∑–Ω—ã—Ö –±—Ä–∞—É–∑–µ—Ä–∞—Ö** - Safari iOS –≤–µ–¥—ë—Ç —Å–µ–±—è –ø–æ-–æ—Å–æ–±–µ–Ω–Ω–æ–º—É

## –î–∞–ª—å–Ω–µ–π—à–∏–µ —É–ª—É—á—à–µ–Ω–∏—è

–í–æ–∑–º–æ–∂–Ω—ã–µ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏:
- [ ] –ü–æ–∫–∞–∑—ã–≤–∞—Ç—å –ø–æ–¥—Å–∫–∞–∑–∫—É –ø—Ä–∏ `denied` —Å—Ç–∞—Ç—É—Å–µ —Å –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–µ–π –ø–æ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—é
- [ ] –ê–Ω–∏–º–∞—Ü–∏—è –∑–µ–ª—ë–Ω–æ–≥–æ –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–∞ –ø—Ä–∏ –ø–µ—Ä–≤–æ–º –ø–æ–ª—É—á–µ–Ω–∏–∏ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è
- [ ] –ö–Ω–æ–ø–∫–∞ "—Å–±—Ä–æ—Å–∏—Ç—å —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ" –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
- [ ] –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–π —á–µ—Ä–µ–∑ `navigator.permissions.addEventListener()`
