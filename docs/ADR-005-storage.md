# ADR-005 — Выбор архитектуры для хранения и доставки медиа-контента OG Lab

## Контекст

OG Lab запускает собственную платформу с публикацией фото и видео, которые невозможно разместить на YouTube/Instagram из‑за ограничений по тематике. Требования:

* Массовая публикация фото и видео (Aftermovies, галереи, образовательный контент).
* Доступность без цензуры, блокировок и ограничений.
* Оптимальная стоимость хранения и трафика.
* Высокая производительность: без лагов, быстрая доставка в Азии (основной рынок — Таиланд).
* Простое управление загрузками и доступом.
* Масштабируемость под рост аудитории.

Рассматривались варианты: DigitalOcean Spaces, AWS S3, Supabase Storage, UploadThing, собственный сервер (Hostinger VPS), Cloudflare R2.

## Решение

Принято использовать **Cloudflare R2 + Cloudflare CDN** в качестве основной инфраструктуры для хранения и доставки.

### Хранилище

* **Cloudflare R2** — дешёвое объектное хранилище без платы за egress через Cloudflare.
* Альтернатива/резерв: DigitalOcean Spaces или Backblaze B2.
* Два бакета:

  * `oglab-media` — оригинальные файлы (фото, видео до обработки).
  * `oglab-hls` — сегменты HLS (m3u8, ts/mp4c).

### Доставка (CDN)

* **Cloudflare CDN** поверх R2.
* Настройка кэширования: сегменты HLS кэшируются долго, плейлисты (`.m3u8`) с коротким TTL.
* Поддержка Range-запросов и адаптивного стриминга.

### Загрузка файлов

* **UploadThing** используется как «входная точка» для фронтенда: безопасные загрузки напрямую в R2.
* Альтернативно — прямой multipart upload в R2 по S3-протоколу.

### Видео-поток (транскодинг)

* Используется **FFmpeg-пайплайн** (воркер на Hostinger или отдельный VPS):

  * Вход: mp4/mov.
  * Выход: HLS с битрейтами 240p, 480p, 720p, 1080p.
  * Генерация превью (poster.jpg) и спрайтов (thumbnail-sprite.jpg).
* Хранение результатов в R2, раздача через CDN.

### Метаданные и доступ

* **Supabase** для хранения метаданных:

  * таблица `media` (id, url, user_id, created_at, тип, размер);
  * таблица `variants` (ссылки на разные качества HLS);
  * таблица `albums/posts` для группировки.
* Управление доступом через **JWT** + **Signed URLs (короткий TTL)**.
* Возрастное ограничение (18+) через роли/флаги в базе.

### Дополнительно

* Превью изображений в webp/avif для экономии трафика.
* Retina-варианты для UI-обложек.
* Логи доступа через Cloudflare Workers → метрики популярности.
* Поддержка кэш‑бастинга при обновлении контента.

## Альтернативы

* **Supabase Storage** — подходит для документов и изображений, но неэффективен для массового видео.
* **DigitalOcean Spaces** — прост в использовании, но трафик дороже, чем у R2.
* **Hostinger VPS** как основное хранилище — риск по масштабируемости и доступности.

## Решение принято

* Основное хранилище и доставка: **Cloudflare R2 + Cloudflare CDN**.
* Загрузка: **UploadThing → R2**.
* Транскодинг: **FFmpeg-воркеры** на нашем VPS по адресу 179.61.246.80, где у нас находится сайт oglab.com и уже настроен ssh root@oglab.com
* Метаданные: **Supabase**.

## Последствия

* Масштабируемое решение, дешёвый трафик (нулевой egress внутри Cloudflare).
* Пользователи получат быстрый просмотр без лагов.
* OG Lab избежит зависимости от соцсетей и сможет публиковать любой легальный контент.
* Нужно поддерживать пайплайн FFmpeg (DevOps-нагрузка).
* Следить за AUP Cloudflare/DO/B2 и маркировать контент как 18+.
