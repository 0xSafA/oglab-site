# ADR-003: Authentication Architecture

## Status
**PROPOSED** - В процессе решения проблем с авторизацией

## Context

### Текущая проблема
Пользователь успешно авторизуется в Supabase, но сессия не сохраняется между клиентом и сервером, что приводит к бесконечному циклу редиректов:

```
1. GET /admin → 307 redirect (middleware не видит пользователя)
2. GET /auth/login → 200 (форма логина)
3. POST /auth/signin → успешная авторизация в браузере
4. Redirect to /admin → 307 redirect (middleware снова не видит пользователя)
```

### Архитектурные компоненты
1. **Next.js 15** с App Router
2. **Supabase Auth** для аутентификации
3. **Middleware** для защиты маршрутов
4. **Server Components** для серверного рендеринга
5. **Client Components** для интерактивности

### Выявленные проблемы

#### 1. Разделение клиент/сервер сессий
- **Клиентский Supabase** (`supabase-client.ts`) - работает в браузере
- **Серверный Supabase** (`supabase-server.ts`) - работает на сервере
- **Middleware Supabase** (`middleware.ts`) - работает на Edge Runtime
- Сессии не синхронизируются между этими контекстами

#### 2. Проблемы с cookies
- Supabase использует cookies для хранения сессии
- Next.js middleware работает на Edge Runtime с ограничениями
- Возможны проблемы с SameSite, Secure флагами
- **КРИТИЧНО**: Middleware не получает обновленные cookies после клиентской авторизации

#### 3. Браузерные расширения
- Firefox расширения мешают работе форм
- `TypeError: "focus" is read-only` от расширений
- Возможная блокировка cookies

## Decision

### Вариант A: Исправление текущей архитектуры (РЕКОМЕНДУЕМЫЙ)

**Подход**: Унификация Supabase клиентов и правильная настройка cookies

**Преимущества**:
- Минимальные изменения в коде
- Использование стандартных паттернов Supabase
- Совместимость с Next.js 15

**Реализация**:
1. Создать единый `createSupabaseClient()` для всех контекстов
2. Настроить правильную передачу cookies в middleware
3. Добавить обработку сессий в Server Components
4. Использовать `supabase.auth.onAuthStateChange()` для синхронизации

### Вариант B: Переход на NextAuth.js

**Подход**: Замена Supabase Auth на NextAuth.js с Supabase как провайдером

**Преимущества**:
- Лучшая интеграция с Next.js
- Встроенная поддержка middleware
- Стандартизированные сессии

**Недостатки**:
- Требует переписывания всей авторизации
- Дополнительная зависимость
- Потеря некоторых возможностей Supabase Auth

### Вариант C: Упрощенная авторизация без middleware

**Подход**: Проверка авторизации в Server Components вместо middleware

**Преимущества**:
- Избегаем проблем с Edge Runtime
- Прямой доступ к Supabase в Server Components
- Простота отладки

**Недостатки**:
- Менее безопасно (страница загружается до проверки)
- Дублирование логики проверки авторизации
- Хуже UX (flash of unauthorized content)

## Implementation Plan

### Фаза 1: Диагностика (ТЕКУЩАЯ)
- [x] Добавить детальное логирование во все компоненты
- [x] Проверить cookies в браузере  
- [ ] **КРИТИЧНО**: Протестировать в разных браузерах без расширений
- [ ] Проверить переменные окружения
- [ ] **ОБНАРУЖЕНО**: Middleware логи не отображаются - проблема с Edge Runtime
- [ ] **ОБНАРУЖЕНО**: Используется устаревший @supabase/ssr вместо правильного паттерна

### Фаза 2: Исправление Supabase клиентов
- [ ] Унифицировать создание клиентов
- [ ] Исправить передачу cookies в middleware
- [ ] Добавить обработку ошибок сессий
- [ ] Протестировать синхронизацию сессий

### Фаза 3: Fallback решения
- [ ] Если Вариант A не работает → Вариант C
- [ ] Если нужна максимальная надежность → Вариант B

## Consequences

### Если выберем Вариант A
- **Положительные**: Быстрое решение, сохранение архитектуры
- **Отрицательные**: Возможны остаточные проблемы с Edge Runtime

### Если выберем Вариант B  
- **Положительные**: Надежная авторизация, стандартный подход
- **Отрицательные**: Большой объем работы, время на переписывание

### Если выберем Вариант C
- **Положительные**: Простота, быстрая реализация
- **Отрицательные**: Менее безопасно, хуже UX

## Next Steps

### НЕМЕДЛЕННЫЕ ДЕЙСТВИЯ:
1. **Тест в чистом браузере** - проверить без расширений Firefox
2. **Если проблема остается** → переходим к Варианту C (убираем middleware)
3. **Если работает** → проблема в расширениях, добавляем обходы

### АРХИТЕКТУРНЫЕ РЕШЕНИЯ:
- **Вариант C как быстрое решение** - убрать middleware, проверять авторизацию в layout.tsx
- **Вариант A для production** - правильная настройка Supabase SSR
- **Вариант B как план Б** - NextAuth.js если Supabase не решается

### ПРИОРИТЕТ: Разблокировать разработку → потом исправить архитектуру

## References
- [Supabase Auth with Next.js](https://supabase.com/docs/guides/auth/auth-helpers/nextjs)
- [Next.js Middleware](https://nextjs.org/docs/app/building-your-application/routing/middleware)
- [NextAuth.js](https://next-auth.js.org/)

---
*Создано: 2025-01-21*  
*Статус: В процессе решения*
