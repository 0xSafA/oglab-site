# ADR-004: Мультиязычная CMS и новостной блог с SEO, RSS и подписками

## Статус
Proposed

## Контекст
Нужно запустить на сайте OG Lab полноценную систему управления контентом (CMS) для блога с видео и текстами о ферме, лайфстайле и каннабисе. Ключевые цели:
- Улучшить индексацию и видимость в поиске и картах
- Сделать контент удобным для чтения на нескольких языках
- Упростить работу редакторов (автоперевод, предпросмотры, планирование)
- Поддержать каналы дистрибуции: RSS и email-подписки

Проект использует Next.js (App Router), Supabase, already has базовую SEO-метаинфу, но отсутствуют i18n-маршрутизация, структурированные мультиязычные страницы и RSS/подписки.

## Решение

### Язык-источник и мультиязычие
- Источником правды для контента является английский (`en`).
- Для каждой локали (`en`, `ru`, `th` на старте) создаются отдельные локализованные версии постов со своими `slug`, `title`, `description`, `body`, медиа `alt` и метаданными.
- UI-строки локализуются через `next-intl`.
- Роутинг с префиксами: `/en` (дефолт), `/ru`, `/th`.

### Хранение контента (Supabase)
- Таблица `posts` — метаданные исходного поста (EN) + общий статус/даты.
- Таблица `post_translations` — переводы по локалям: `locale`, `title`, `slug`, `excerpt`, `body_md`, `seo_title`, `seo_description`, `og_image_url`, источник перевода, статус ревью.
- Медиафайлы хранятся в объектном хранилище; обложки и изображения имеют локализованные `alt`.

### Генерация переводов
- Автоперевод через OpenAI как draft (seed), обязателен human-review перед публикацией.
- Храним `translation_source` (`ai`/`human`) и `review_status` (`needs_review`/`approved`).

### Публикация и производительность
- SSG + ISR: страницы постов и листинги предгенерируются, перевыдача по расписанию (`revalidate`).
- `generateStaticParams` на `[locale]/blog/[slug]` для всех опубликованных переводов.
- Изображения через `next/image`, ленивые видео, кэш-заголовки в `next.config.ts`.

### SEO и мультиязычие
- Локализованные `title`, `description`, OG/Twitter карточки на каждой языковой версии.
- `hreflang` и `x-default` между версиями; каноникал при необходимости.
- Структурированные данные: `Article/BlogPosting`, `VideoObject`, `BreadcrumbList`; на контактах — `LocalBusiness` (координаты, часы, телефон, URL соцсетей).
- Отдельные Google Search Console properties для корня и подкаталогов `/ru`, `/th`.

### RSS
- Генерация RSS (и опционально Atom/JSON Feed) по каждой локали: `/en/rss.xml`, `/ru/rss.xml`, `/th/rss.xml`.
- Включать `title`, `link`, `description`, `pubDate`, локализованные `guid`/`slug`, ссылку на обложку и автора.
- Автообновление при публикации/правках (ISR/он-деманд ревалидейшн).

### Подписки (email)
- Форма подписки для пользователей (минимум: email, согласие).
- Double opt-in: письмо подтверждения для валидации адреса.
- Сегменты по языкам; рассылка локализованных материалов.
- Интеграция с email-провайдером (на выбор: Resend/SendGrid/Postmark/Mailchimp). Хранить подписчиков в Supabase (`subscribers`) с полями `email`, `locale`, `status`, `confirmed_at`, `unsubscribed_at`, `source`.
- Уважать `unsubscribe` (линк в письме), политики GDPR/PDPA.

### Кросс‑постинг (Reddit, Medium, X/Twitter, Facebook, Instagram, Tripadvisor)
- Цель: расширение охвата и трафика, присутствие в профильных сообществах и агрегаторах.
- Поддержать генерацию облегчённых версий постов (teaser/intro) без прямых упоминаний запрещённых слов (например, «cannabis»), с нейтральной лексикой и ссылкой на полную версию на сайте.
- Профили платформ:
  - Reddit: публикация в релевантных сабреддитах с соблюдением правил; акцент на информативность и прозрачные дисклеймеры, без промо и запрещённой терминологии; CTA — перейти на сайт за полнотекстовой версией.
  - Medium: зеркальная публикация или адаптированная версия с каноникалом на оригинал; аккуратная редактура, нейтральная терминология, теги Medium.
  - X/Twitter: короткие треды/тизеры, медиакарточки, ссылка на сайт, соответствие правилам площадки.
  - Facebook: длинные тизеры, клипсы/ролики, карточки событий/анонсов; строгий sanitize по лексике; UTM.
  - Instagram: карусели/сторис/рйлс, короткие тексты, ссылка через био/линк‑ин‑био; соблюдение ограничений по тематике.
  - Tripadvisor: публикация новостей/ивентов/обновлений на странице бизнеса, акцент на тур‑аудиторию и опыт посещения; нейтральные формулировки.
- Инструменты:
  - Шаблоны кросс‑постов per платформа + автогенерация (AI draft) в админке с опцией "sanitize language".
  - Проверки на запрещённые слова, допустимые синонимы/эвфемизмы (глоссарий).
  - Хранение подготовленных кросс‑пост версий в БД c типом платформы, локалью и статусом публикации.
  - Каноникал/атрибуция: для Medium — `rel=canonical` на оригинал; UTM‑метки для аналитики.
- Публикационный флоу:
  1) В админке на странице поста — вкладка "Кросс‑пост".
  2) Генерация черновиков адаптаций (per локаль и платформа) → ручная правка → статус `approved`.
  3) Публикация вручную или через API‑интеграции/запланированно, с трекингом ссылки/ID поста.
  4) Отчёт в аналитике по переходам (UTM, рефереры) и вовлечённости.

### Админ-флоу (редакторы)
1. Создать пост (EN): заполнить `title`, `slug`, `excerpt`, `body_md`, обложку, SEO-поля.
2. Нажать "Автоперевод" → создать `post_translations` для выбранных локалей (как draft).
3. Редактор проверяет/редактирует переводы, ставит `approved`.
4. Предпросмотр по приватной ссылке (tokenized preview) для каждой локали.
5. Публикация (сейчас/план): задаётся `published_at` и `status=published`; триггерится ревалидейшн.
6. Опционально: отправка рассылки и добавление в топовые блоки/серию.
7. Кросс‑постинг: создание адаптаций (sanitize), ревью, публикация в Reddit/Medium/X/Facebook/Instagram/Tripadvisor с UTM и каноникалом (где применимо).

### Пользовательский флоу
- Список постов по локали с пагинацией, фильтрами (рубрики/теги), быстрыми превью-карточками, временем чтения.
- Страница поста: оглавление, похожие материалы, карточка автора, локализованные медиа-альты, легковесные комментарии/реакции (если включим).
- RSS по локали; форма подписки; оповещения о новых материалах по email.

## Альтернативы
- Runtime‑перевод на клиенте: быстро, но слабый SEO и неоднородное качество — отклонено.
- Полностью ручные переводы: высокое качество, но дорого и медленно — используем гибрид (AI seed + review человеком).
- Внешний headless CMS: богаче редакторский опыт, но добавляет комплексность и стоимость — сейчас остаёмся на Supabase.

## Влияние
- Улучшаем видимость в поиске за счёт локализованных страниц и структурированных данных.
- Повышаем удобство редакторов (автоперевод, предпросмотр, планирование) и пользователей (скорость, навигация, подписки).
- Небольшой рост операционных задач (ревью переводов, рассылки), но с высокой отдачей.

## План внедрения (итеративно)
1. I18n роутинг (`next-intl`), локали `en` (дефолт), `ru`, `th`; базовая навигация.
2. Миграции Supabase: `posts`, `post_translations`, `subscribers`.
3. Страницы: `[locale]/blog`, `[locale]/blog/[slug]` с `generateStaticParams` и SSG+ISR.
4. SEO: локализованные `metadata`, `hreflang`, JSON‑LD; `sitemap.ts` с alternate refs и `robots.ts`.
5. RSS: `/{locale}/rss.xml` генерация из опубликованных постов.
6. Админка: автоперевод, статусы ревью, предпросмотр по токену, планирование публикаций.
7. Подписки: форма, double opt‑in, рассылка на локали, `unsubscribe`.
8. Кросс‑постинг: схемы БД для адаптаций, шаблоны, sanitize/глоссарий, UTM и (если нужно) интеграции API платформ, вкл. Facebook/Instagram/Tripadvisor.
9. Карты/локальное SEO: JSON‑LD `LocalBusiness`, обновление профилей (GBP/Apple/Bing).
10. Хранилище кросс‑постов и метрик: миграции `post_shares` и `post_share_metrics`, сбор и отображение статистики.

## Хранилище кросс‑постов и метрик
### Цели
- Фиксировать, где/когда/в каком виде опубликована каждая локализованная версия поста на внешних платформах.
- Хранить ссылки/ID на внешний пост, статус публикации, тизер/контент адаптации, UTM и базовые метрики.

### Схема (Supabase/Postgres)
```
-- post_shares: факты кросс‑постинга
create type share_platform as enum ('reddit','medium','twitter','facebook','instagram','tripadvisor');
create type share_status as enum ('draft','scheduled','published','failed');

create table post_shares (
  id uuid primary key default gen_random_uuid(),
  post_translation_id uuid not null references post_translations(id) on delete cascade,
  platform share_platform not null,
  locale text not null,
  title_override text,
  content_md text,
  media_refs jsonb,
  utm_source text,
  utm_campaign text,
  status share_status not null default 'draft',
  scheduled_at timestamptz,
  published_at timestamptz,
  external_post_id text,
  external_url text,
  moderation_notes text,
  created_at timestamptz default now(),
  updated_at timestamptz default now()
);

create unique index uniq_share_per_translation_platform
  on post_shares (post_translation_id, platform)
  where status = 'published';

create index idx_post_shares_platform_status on post_shares (platform, status);
create index idx_post_shares_scheduled_at on post_shares (scheduled_at);

-- метрики по кросс‑постам (опционально расширяем)
create table post_share_metrics (
  id uuid primary key default gen_random_uuid(),
  post_share_id uuid not null references post_shares(id) on delete cascade,
  fetched_at timestamptz not null default now(),
  impressions bigint,
  likes bigint,
  comments bigint,
  shares bigint,
  saves bigint
);
```

### Заметки по интеграциям
- Для Medium — указывать `rel=canonical` на оригинал.
- Для X/Twitter/FB/Instagram — UTM‑метки; статусы `scheduled/published` для планеров.
- Tripadvisor — ориентир на контент об опыте посещения; возможна ручная публикация без API.

## Риски и митигирование
- Качество автопереводов: вводим обязательный human‑review и глоссарий терминов.
- Рост количества URL: автоматические редиректы при смене `slug`, линк‑чекер.
- Доставка писем: мониторинг доставляемости, DKIM/SPF/DMARC, чёткий opt‑in и отписка.

## Открытые вопросы
- Стартовый набор языков: `en`, `ru`, `th` — подтвердить.
- Выбор email‑провайдера для рассылок.
- Будем ли добавлять комментарии/реакции на первом релизе?


