# üìã –†–µ–∑—é–º–µ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–π - 5 –æ–∫—Ç—è–±—Ä—è 2025

## –û–±–∑–æ—Ä –∏–∑–º–µ–Ω–µ–Ω–∏–π

–í —ç—Ç–æ–π —Å–µ—Å—Å–∏–∏ –±—ã–ª–∏ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω—ã **–¥–≤–µ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏** –¥–ª—è AI Agent:

1. ‚ö° **–ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –º–µ–Ω—é** (30 –º–∏–Ω—É—Ç TTL)
2. üé§ **–û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è —Ä–∞–±–æ—Ç—ã —Å —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è–º–∏ –º–∏–∫—Ä–æ—Ñ–æ–Ω–∞**

---

## 1. ‚ö° –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ –º–µ–Ω—é (AGENT_CACHE_OPTIMIZATION.md)

### –ü—Ä–æ–±–ª–µ–º–∞
–ê–≥–µ–Ω—Ç –¥–µ–ª–∞–ª **2 –∑–∞–ø—Ä–æ—Å–∞ –∫ –ë–î** –ø—Ä–∏ –∫–∞–∂–¥–æ–º —Å–æ–æ–±—â–µ–Ω–∏–∏:
- –û–¥–∏–Ω –¥–ª—è —Ç–µ–∫—Å—Ç–æ–≤–æ–≥–æ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ (–ø—Ä–æ–º–ø—Ç GPT)
- –í—Ç–æ—Ä–æ–π –¥–ª—è –∫–∞—Ä—Ç–æ—á–µ–∫ –ø—Ä–æ–¥—É–∫—Ç–æ–≤ (UI)

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** ~1000-1500ms –∑–∞–¥–µ—Ä–∂–∫–∞ –æ—Ç–≤–µ—Ç–∞

### –†–µ—à–µ–Ω–∏–µ

#### –°–µ—Ä–≤–µ—Ä–Ω–∞—è —Å—Ç–æ—Ä–æ–Ω–∞ (`src/app/api/agent/chat/route.ts`):
```typescript
let menuCache: {
  contextText: string;  // –¥–ª—è GPT
  rows: MenuRow[];      // –¥–ª—è –∫–∞—Ä—Ç–æ—á–µ–∫
  timestamp: number;
} | null = null;

const MENU_CACHE_TTL = 30 * 60 * 1000; // 30 –º–∏–Ω—É—Ç
```

- ‚úÖ –ö—ç—à —Ö—Ä–∞–Ω–∏—Ç –∏ –∫–æ–Ω—Ç–µ–∫—Å—Ç, –∏ –¥–∞–Ω–Ω—ã–µ
- ‚úÖ –¢–æ–ª—å–∫–æ **1 –∑–∞–ø—Ä–æ—Å –∫ –ë–î** –∫–∞–∂–¥—ã–µ 30 –º–∏–Ω—É—Ç
- ‚úÖ –ù–æ–≤—ã–π `HEAD /api/agent/chat` endpoint –¥–ª—è prefetch

#### –ö–ª–∏–µ–Ω—Ç—Å–∫–∞—è —Å—Ç–æ—Ä–æ–Ω–∞ (`src/components/OGLabAgent.tsx`):
```typescript
// Prefetch –ø—Ä–∏ –ø–µ—Ä–≤–æ–º –≤–≤–æ–¥–µ —Å–∏–º–≤–æ–ª–∞
if (!cachePrefetched && e.target.value.length === 1) {
  prefetchMenuCache()
}

// Prefetch –ø—Ä–∏ –Ω–∞—á–∞–ª–µ –≥–æ–ª–æ—Å–æ–≤–æ–π –∑–∞–ø–∏—Å–∏
if (!cachePrefetched) {
  prefetchMenuCache()
}
```

### –†–µ–∑—É–ª—å—Ç–∞—Ç
- üìä **0 –∑–∞–ø—Ä–æ—Å–æ–≤ –∫ –ë–î** (–ø—Ä–∏ –ø–æ–ø–∞–¥–∞–Ω–∏–∏ –≤ –∫—ç—à)
- ‚è±Ô∏è ~**500-800ms** –≤—Ä–µ–º—è –æ—Ç–≤–µ—Ç–∞ (–±—ã–ª–æ 1000-1500ms)
- üöÄ Prefetch –ø—Ä–æ–≥—Ä–µ–≤–∞–µ—Ç –∫—ç—à –∑–∞—Ä–∞–Ω–µ–µ
- üíæ –ö—ç—à –∂–∏–≤—ë—Ç **30 –º–∏–Ω—É—Ç**

### API Endpoints

#### `GET /api/agent/chat` - –°—Ç–∞—Ç—É—Å –∫—ç—à–∞
```json
{
  "status": "ok",
  "cache": {
    "exists": true,
    "age_seconds": 450,
    "ttl_seconds": 1800,
    "expired": false,
    "items_count": 85
  }
}
```

#### `HEAD /api/agent/chat` - Prefetch –∫—ç—à–∞
–ü—Ä–æ–≥—Ä–µ–≤–∞–µ—Ç –∫—ç—à –±–µ–∑ –ø–æ–ª—É—á–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö. Headers:
- `X-Cache-Status`: hit/miss
- `X-Items-Count`: –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø—Ä–æ–¥—É–∫—Ç–æ–≤
- `X-Cache-Age`: –≤–æ–∑—Ä–∞—Å—Ç –∫—ç—à–∞ –≤ —Å–µ–∫—É–Ω–¥–∞—Ö

---

## 2. üé§ –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –º–∏–∫—Ä–æ—Ñ–æ–Ω–∞ (MICROPHONE_PERMISSION_OPTIMIZATION.md)

### –ü—Ä–æ–±–ª–µ–º–∞
–ë—Ä–∞—É–∑–µ—Ä –∑–∞–ø—Ä–∞—à–∏–≤–∞–ª —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ –Ω–∞ –º–∏–∫—Ä–æ—Ñ–æ–Ω **–ø—Ä–∏ –∫–∞–∂–¥–æ–º –Ω–∞–∂–∞—Ç–∏–∏** –∫–Ω–æ–ø–∫–∏ –∑–∞–ø–∏—Å–∏, –¥–∞–∂–µ –µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–∂–µ —Ä–∞–∑—Ä–µ—à–∏–ª.

### –ü—Ä–∏—á–∏–Ω—ã
1. Stream –∑–∞–∫—Ä—ã–≤–∞–ª—Å—è –ø–æ—Å–ª–µ –∫–∞–∂–¥–æ–π –∑–∞–ø–∏—Å–∏
2. –ù–æ–≤—ã–π `getUserMedia()` –ø—Ä–∏ –∫–∞–∂–¥–æ–º –∑–∞–ø—É—Å–∫–µ
3. –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–π —á–µ—Ä–µ–∑ Permissions API

### –†–µ—à–µ–Ω–∏–µ

#### –ü–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ MediaStream (`src/lib/audio-recorder.ts`):
```typescript
// –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ —É–∂–µ –∞–∫—Ç–∏–≤–Ω—ã–π stream
if (!this.stream || !this.stream.active) {
  // –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –Ω–µ—Ç
  this.stream = await navigator.mediaDevices.getUserMedia({ ... });
} else {
  // –ü–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π
  console.log('üì¶ Reusing existing microphone stream');
}
```

#### Permissions API:
```typescript
static async checkMicrophonePermission(): Promise<'granted' | 'denied' | 'prompt'> {
  const result = await navigator.permissions.query({ name: 'microphone' });
  return result.state;
}
```

#### –î–≤–∞ –º–µ—Ç–æ–¥–∞ –æ—á–∏—Å—Ç–∫–∏:
- `cleanup()` - –ø–æ—Å–ª–µ –∑–∞–ø–∏—Å–∏ (–ù–ï –∑–∞–∫—Ä—ã–≤–∞–µ—Ç stream)
- `destroy()` - –ø—Ä–∏ —Ä–∞–∑–º–æ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏ (–∑–∞–∫—Ä—ã–≤–∞–µ—Ç –≤—Å—ë)

#### –í–∏–∑—É–∞–ª—å–Ω—ã–π –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä:
- üü¢ –ó–µ–ª—ë–Ω–∞—è —Ç–æ—á–∫–∞ –Ω–∞ –∫–Ω–æ–ø–∫–µ –º–∏–∫—Ä–æ—Ñ–æ–Ω–∞
- –ó–µ–ª—ë–Ω–∞—è –æ–±–≤–æ–¥–∫–∞ –∫–æ–≥–¥–∞ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ –¥–∞–Ω–æ
- –¶–≤–µ—Ç –º–µ–Ω—è–µ—Ç—Å—è –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Å—Ç–∞—Ç—É—Å–∞

### –†–µ–∑—É–ª—å—Ç–∞—Ç
- ‚úÖ –†–∞–∑—Ä–µ—à–µ–Ω–∏–µ –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ—Ç—Å—è **—Ç–æ–ª—å–∫–æ –æ–¥–∏–Ω —Ä–∞–∑**
- ‚úÖ Stream –ø–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –º–µ–∂–¥—É –∑–∞–ø–∏—Å—è–º–∏
- ‚úÖ –í–∏–∑—É–∞–ª—å–Ω—ã–π –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä —Å—Ç–∞—Ç—É—Å–∞
- ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ —á–µ—Ä–µ–∑ Permissions API
- üéâ –ü–ª–∞–≤–Ω—ã–π UX –±–µ–∑ –ª–∏—à–Ω–∏—Ö –ø–æ–ø–∞–ø–æ–≤

---

## –§–∞–π–ª—ã –∏–∑–º–µ–Ω–µ–Ω—ã

### Backend:
- ‚úÖ `src/app/api/agent/chat/route.ts` - –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ –º–µ–Ω—é
- ‚úÖ `src/lib/audio-recorder.ts` - –ø–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ stream

### Frontend:
- ‚úÖ `src/components/OGLabAgent.tsx` - prefetch –∫—ç—à–∞ + –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –º–∏–∫—Ä–æ—Ñ–æ–Ω–∞

### –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è:
- ‚úÖ `docs/AGENT_CACHE_OPTIMIZATION.md`
- ‚úÖ `docs/MICROPHONE_PERMISSION_OPTIMIZATION.md`
- ‚úÖ `docs/SESSION_SUMMARY_OPTIMIZATIONS.md` (—ç—Ç–æ—Ç —Ñ–∞–π–ª)

---

## –ú–µ—Ç—Ä–∏–∫–∏ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏

| –ú–µ—Ç—Ä–∏–∫–∞ | –î–æ | –ü–æ—Å–ª–µ | –£–ª—É—á—à–µ–Ω–∏–µ |
|---------|-----|--------|-----------|
| –ó–∞–ø—Ä–æ—Å–æ–≤ –∫ –ë–î (–Ω–∞ —Å–æ–æ–±—â–µ–Ω–∏–µ) | 2 | 0-1* | **100%** |
| –í—Ä–µ–º—è –æ—Ç–≤–µ—Ç–∞ –∞–≥–µ–Ω—Ç–∞ | 1000-1500ms | 500-800ms | **40-50%** |
| –ó–∞–ø—Ä–æ—Å–æ–≤ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è –º–∏–∫—Ä–æ—Ñ–æ–Ω–∞ | –ö–∞–∂–¥—ã–π —Ä–∞–∑ | 1 —Ä–∞–∑ | **100%** |
| MediaStream –æ–±—ä–µ–∫—Ç–æ–≤ | –ù–æ–≤—ã–π –∫–∞–∂–¥—ã–π —Ä–∞–∑ | 1 –ø–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–π | **–≠–∫–æ–Ω–æ–º–∏—è –ø–∞–º—è—Ç–∏** |

\* 0 –ø—Ä–∏ –ø–æ–ø–∞–¥–∞–Ω–∏–∏ –≤ –∫—ç—à, 1 –ø—Ä–∏ –ø–µ—Ä–≤–æ–º –∑–∞–ø—Ä–æ—Å–µ –∏–ª–∏ –∏—Å—Ç–µ—á–µ–Ω–∏–∏ TTL

---

## –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### –ö—ç—à –º–µ–Ω—é:
```bash
# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç–∞—Ç—É—Å
curl https://your-domain.com/api/agent/chat

# –ü—Ä–æ–≥—Ä–µ—Ç—å –∫—ç—à –≤—Ä—É—á–Ω—É—é
curl -I https://your-domain.com/api/agent/chat
```

### –ú–∏–∫—Ä–æ—Ñ–æ–Ω:
1. –û—Ç–∫—Ä–æ–π—Ç–µ –∞–≥–µ–Ω—Ç–∞ –≤ –±—Ä–∞—É–∑–µ—Ä–µ
2. –ù–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É –º–∏–∫—Ä–æ—Ñ–æ–Ω–∞ - –¥–æ–ª–∂–µ–Ω –∑–∞–ø—Ä–æ—Å–∏—Ç—å —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ
3. –†–∞–∑—Ä–µ—à–∏—Ç–µ –¥–æ—Å—Ç—É–ø
4. –î–æ–ª–∂–Ω–∞ –ø–æ—è–≤–∏—Ç—å—Å—è üü¢ –∑–µ–ª—ë–Ω–∞—è —Ç–æ—á–∫–∞
5. –ù–∞–∂–º–∏—Ç–µ –µ—â—ë —Ä–∞–∑ - **–ù–ï –¥–æ–ª–∂–µ–Ω** —Å–ø—Ä–∞—à–∏–≤–∞—Ç—å —Å–Ω–æ–≤–∞
6. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∫–æ–Ω—Å–æ–ª—å: `üì¶ Reusing existing microphone stream`

---

## –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏

### –û–±—Å—É–∂–¥–∞–ª–æ—Å—å, –Ω–æ –Ω–µ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ:
- üì® **Telegram —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è** - –æ—Ç–ø—Ä–∞–≤–∫–∞ –∑–∞–∫–∞–∑–æ–≤/—Å–æ–æ–±—â–µ–Ω–∏–π –≤ Telegram
  - –ù—É–∂–µ–Ω Telegram Bot Token
  - –û–ø—Ä–µ–¥–µ–ª–∏—Ç—å —Å—Ü–µ–Ω–∞—Ä–∏–∏ (–∑–∞–∫–∞–∑ vs —Å–æ–æ–±—â–µ–Ω–∏–µ –º–µ–Ω–µ–¥–∂–µ—Ä—É)
  - API endpoint `/api/telegram/notify`

### –ü–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–µ —É–ª—É—á—à–µ–Ω–∏—è:
- [ ] Redis –¥–ª—è –∫—ç—à–∞ (–¥–ª—è –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã—Ö –∏–Ω—Å—Ç–∞–Ω—Å–æ–≤)
- [ ] Webhook –æ—Ç Supabase –¥–ª—è –∏–Ω–≤–∞–ª–∏–¥–∞—Ü–∏–∏ –∫—ç—à–∞
- [ ] Streaming –æ—Ç–≤–µ—Ç–æ–≤ –æ—Ç GPT (SSE)
- [ ] –ü–æ–∫–∞–∑—ã–≤–∞—Ç—å –ø–æ–¥—Å–∫–∞–∑–∫—É –ø—Ä–∏ `denied` —Å—Ç–∞—Ç—É—Å–µ –º–∏–∫—Ä–æ—Ñ–æ–Ω–∞
- [ ] –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–π —á–µ—Ä–µ–∑ events

---

## –¢—Ä–µ–±–æ–≤–∞–Ω–∏—è

### –û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ:
- ‚úÖ Next.js 15.5.3
- ‚úÖ React 19
- ‚úÖ HTTPS (–¥–ª—è Permissions API –∏ —Ö—Ä–∞–Ω–µ–Ω–∏—è —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–π)

### –†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è:
- Chrome/Firefox 90+ (–ø–æ–ª–Ω–∞—è –ø–æ–¥–¥–µ—Ä–∂–∫–∞ Permissions API)
- Safari 15+ (—á–∞—Å—Ç–∏—á–Ω–∞—è –ø–æ–¥–¥–µ—Ä–∂–∫–∞)

---

## –ó–∞–º–µ—Ç–∫–∏

1. **–ö—ç—à –∂–∏–≤—ë—Ç 30 –º–∏–Ω—É—Ç** - –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –º–µ–Ω—é –ø–æ–¥–æ–∂–¥–∏—Ç–µ –∏–ª–∏ –ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–µ —Å–µ—Ä–≤–µ—Ä
2. **Safari iOS –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç Permissions API** - –Ω–æ –ø–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ stream –≤—Å—ë —Ä–∞–≤–Ω–æ —Ä–∞–±–æ—Ç–∞–µ—Ç
3. **HTTP –Ω–µ –∑–∞–ø–æ–º–∏–Ω–∞–µ—Ç —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è** - –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ HTTPS (–∫—Ä–æ–º–µ localhost)
4. **Prefetch —Å—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –ø—Ä–∏ –ø–µ—Ä–≤–æ–º —Å–∏–º–≤–æ–ª–µ** –∏–ª–∏ –ø—Ä–∏ –Ω–∞—á–∞–ª–µ –∑–∞–ø–∏—Å–∏

---

## –ö–æ–Ω—Ç–∞–∫—Ç—ã

- Telegram: @AlexanderSafiulin
- GitHub: /oglab-site

**–î–∞—Ç–∞:** 5 –æ–∫—Ç—è–±—Ä—è 2025  
**–í–µ—Ä—Å–∏—è:** 1.0
