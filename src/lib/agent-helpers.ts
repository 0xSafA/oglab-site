/**
 * AI Agent Helper Functions
 * Utilities for building context, prompts, and managing conversations
 */

import type { MenuRow } from './supabase-data';

/**
 * –û–ø—Ä–µ–¥–µ–ª—è–µ—Ç —ç—Ñ—Ñ–µ–∫—Ç—ã —Å–æ—Ä—Ç–∞ –Ω–∞ –æ—Å–Ω–æ–≤–µ —Ç–∏–ø–∞ (–∫–æ—Ä–æ—Ç–∫–∏–µ, 2-3 —Å–ª–æ–≤–∞)
 */
export function getStrainEffects(type: string | null | undefined): string {
  if (!type) return '–±–∞–ª–∞–Ω—Å';
  
  const effects: Record<string, string> = {
    indica: '—Ä–µ–ª–∞–∫—Å, —Å–æ–Ω, —Å–ø–æ–∫–æ–π—Å—Ç–≤–∏–µ',
    sativa: '—ç–Ω–µ—Ä–≥–∏—è, –∫—Ä–µ–∞—Ç–∏–≤, —Ñ–æ–∫—É—Å',
    hybrid: '–±–∞–ª–∞–Ω—Å, –≥–∏–±–∫–æ—Å—Ç—å',
    hybride: '–±–∞–ª–∞–Ω—Å, –≥–∏–±–∫–æ—Å—Ç—å',
  };
  
  return effects[type.toLowerCase()] || '–±–∞–ª–∞–Ω—Å';
}

/**
 * –û–ø—Ä–µ–¥–µ–ª—è–µ—Ç –≤–∫—É—Å–æ–≤—ã–µ –Ω–æ—Ç—ã —Å–æ—Ä—Ç–∞ –Ω–∞ –æ—Å–Ω–æ–≤–µ —Ç–∏–ø–∞ (–∫–æ—Ä–æ—Ç–∫–∏–µ, 2-3 —Å–ª–æ–≤–∞)
 */
export function getStrainFlavors(type: string | null | undefined): string {
  if (!type) return '–∑–µ–º–ª—è, —Ç—Ä–∞–≤–∞';
  
  const flavors: Record<string, string> = {
    indica: '–∑–µ–º–ª—è, —Å–ª–∞–¥–æ—Å—Ç—å, —è–≥–æ–¥—ã',
    sativa: '—Ü–∏—Ç—Ä—É—Å, —Ö–≤–æ—è, —Å–ø–µ—Ü–∏–∏',
    hybrid: '—Ñ—Ä—É–∫—Ç—ã, –∑–µ–º–ª—è, —Å–ª–∞–¥–æ—Å—Ç—å',
    hybride: '—Ñ—Ä—É–∫—Ç—ã, –∑–µ–º–ª—è, —Å–ª–∞–¥–æ—Å—Ç—å',
  };
  
  return flavors[type.toLowerCase()] || '–∑–µ–º–ª—è, —Ç—Ä–∞–≤–∞';
}

/**
 * –°—Ç—Ä–æ–∏—Ç –∫—Ä–∞—Ç–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ –ø—Ä–æ–¥—É–∫—Ç–∞ –¥–ª—è –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞
 */
export function formatProductForContext(item: MenuRow): string {
  const parts: string[] = [];
  
  // –ù–∞–∑–≤–∞–Ω–∏–µ –∏ –∫–∞—Ç–µ–≥–æ—Ä–∏—è
  parts.push(`${item.Name} (${item.Category}`);
  
  // –¢–∏–ø
  if (item.Type) {
    parts.push(`, ${item.Type}`);
  }
  
  // THC/CBG
  if (item.THC) {
    parts.push(`, THC ${item.THC}%`);
  } else if (item.CBG) {
    parts.push(`, CBG ${item.CBG}%`);
  }
  
  parts.push(')');
  
  // –≠—Ñ—Ñ–µ–∫—Ç—ã
  const effects = getStrainEffects(item.Type);
  parts.push(` ‚Äî ${effects}`);
  
  // –ù–∞—à–∞ –æ—Ç–º–µ—Ç–∫–∞
  if (item.Our) {
    parts.push(' üåø [–ù–∞—à–µ –ø—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–æ]');
  }
  
  return parts.join('');
}

/**
 * –°—Ç—Ä–æ–∏—Ç –ø–æ–ª–Ω—ã–π –∫–æ–Ω—Ç–µ–∫—Å—Ç –º–µ–Ω—é –¥–ª—è –ø—Ä–æ–º–ø—Ç–∞
 */
export function buildMenuContext(menuItems: MenuRow[]): string {
  if (!menuItems || menuItems.length === 0) {
    return '–ê—Å—Å–æ—Ä—Ç–∏–º–µ–Ω—Ç –≤—Ä–µ–º–µ–Ω–Ω–æ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω.';
  }

  // –ì—Ä—É–ø–ø–∏—Ä—É–µ–º –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º
  const categories = new Map<string, MenuRow[]>();
  
  menuItems.forEach(item => {
    const category = item.Category || '–î—Ä—É–≥–æ–µ';
    if (!categories.has(category)) {
      categories.set(category, []);
    }
    categories.get(category)!.push(item);
  });

  // –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –¥–ª—è –ø—Ä–æ–º–ø—Ç–∞
  const lines: string[] = ['–¢–ï–ö–£–©–ò–ô –ê–°–°–û–†–¢–ò–ú–ï–ù–¢:', ''];
  
  categories.forEach((items, category) => {
    lines.push(`üì¶ ${category}:`);
    items.forEach(item => {
      lines.push(`  ‚Ä¢ ${formatProductForContext(item)}`);
    });
    lines.push('');
  });

  return lines.join('\n');
}

/**
 * –°—Ç—Ä–æ–∏—Ç system prompt –¥–ª—è GPT
 */
export function buildSystemPrompt(params: {
  menuContext?: string;
  userContext?: string;
  useStock: boolean;
  language?: string;
}): string {
  const { menuContext, userContext, useStock, language = 'ru' } = params;

  return `–¢—ã ‚Äî –≤–∏—Ä—Ç—É–∞–ª—å–Ω—ã–π –±–∞–¥—Ç–µ–Ω–¥–µ—Ä OG Lab, –ø—Ä–µ–º–∏–∞–ª—å–Ω–æ–≥–æ –∫–∞–Ω–Ω–∞–±–∏—Å-–¥–∏—Å–ø–µ–Ω—Å–∞—Ä–∏ –Ω–∞ –æ—Å—Ç—Ä–æ–≤–µ –°–∞–º—É–∏, –¢–∞–∏–ª–∞–Ω–¥.

–¢–í–û–Ø –õ–ò–ß–ù–û–°–¢–¨:
- –î—Ä—É–∂–µ–ª—é–±–Ω—ã–π, –º—É–¥—Ä—ã–π –∏ —á—É—Ç–∫–∏–π —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫ —Å –Ω–µ—Ñ–æ—Ä–º–∞–ª—å–Ω—ã–º —Å—Ç–∏–ª–µ–º –æ–±—â–µ–Ω–∏—è
- –û–±—â–∞–µ—à—å—Å—è –∫–∞–∫ —Å —Ö–æ—Ä–æ—à–∏–º –¥—Ä—É–≥–æ–º ‚Äî –Ω–∞ "—Ç—ã", –ª–µ–≥–∫–æ, –±–µ–∑ –æ—Ñ–∏—Ü–∏–æ–∑–∞
- –°–æ—á–µ—Ç–∞–µ—à—å –∑–Ω–∞–Ω–∏—è –æ –∫–∞–Ω–Ω–∞–±–∏—Å–µ —Å —Ñ–∏–ª–æ—Å–æ—Ñ–∏–µ–π –æ—Å–æ–∑–Ω–∞–Ω–Ω–æ—Å—Ç–∏ –∏ —Ö–æ—Ä–æ—à–∏–º —é–º–æ—Ä–æ–º
- –í–¥–æ—Ö–Ω–æ–≤–ª–µ–Ω –¥—É—Ö–æ–º –ë–æ–±–∞ –ú–∞—Ä–ª–∏, –º—É–¥—Ä–æ—Å—Ç—å—é –≠–∫—Ö–∞—Ä—Ç–∞ –¢–æ–ª–ª–µ, —É—á–µ–Ω–∏—è–º–∏ –ë—É–¥–¥—ã
- –£–º–µ–µ—à—å –≥–æ–≤–æ—Ä–∏—Ç—å –æ –¥—É—Ö–æ–≤–Ω–æ–º —Ä–æ—Å—Ç–µ, –º–µ–¥–∏—Ç–∞—Ü–∏–∏, —Ç–≤–æ—Ä—á–µ—Å—Ç–≤–µ
- –ù–∏–∫–æ–≥–¥–∞ –Ω–µ –æ—Å—É–∂–¥–∞–µ—à—å, –≤—Å–µ–≥–¥–∞ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—à—å
- –í–µ—Å–µ–ª–∏—à—å, —à—É—Ç–∏—à—å, —Å–æ–∑–¥–∞—ë—à—å –ª—ë–≥–∫—É—é –∞—Ç–º–æ—Å—Ñ–µ—Ä—É
- –ü—Ä–æ—è–≤–ª—è–µ—à—å –∏–Ω–∏—Ü–∏–∞—Ç–∏–≤—É: –∑–∞–¥–∞—ë—à—å –≤–æ–ø—Ä–æ—Å—ã, –ø—Ä–µ–¥–ª–∞–≥–∞–µ—à—å –∏–¥–µ–∏, –¥–µ–ª–∏—à—å—Å—è –∏–Ω—Ç–µ—Ä–µ—Å–Ω—ã–º–∏ —Ñ–∞–∫—Ç–∞–º–∏

–¢–í–û–Ø –ó–ê–î–ê–ß–ê:
1. –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –¥–æ–≤–µ—Ä–∏—Ç–µ–ª—å–Ω—ã–π –∫–æ–Ω—Ç–∞–∫—Ç
2. –í—ã—è—Å–Ω–∏—Ç—å –ø–æ—Ç—Ä–µ–±–Ω–æ—Å—Ç–∏ –∫–ª–∏–µ–Ω—Ç–∞ (–Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ, –ø–ª–∞–Ω—ã, –æ–ø—ã—Ç)
3. –†–µ–∫–æ–º–µ–Ω–¥–æ–≤–∞—Ç—å –ø–æ–¥—Ö–æ–¥—è—â–∏–µ –ø—Ä–æ–¥—É–∫—Ç—ã –∏–∑ –Ω–∞—à–µ–≥–æ –∞—Å—Å–æ—Ä—Ç–∏–º–µ–Ω—Ç–∞
4. –û–±—ä—è—Å–Ω–∏—Ç—å, –ø–æ—á–µ–º—É –∏–º–µ–Ω–Ω–æ —ç—Ç–∏ —Å–æ—Ä—Ç–∞ –ø–æ–¥—Ö–æ–¥—è—Ç

–í–ê–ñ–ù–´–ï –ü–†–ê–í–ò–õ–ê:
- **–û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û —É–ø–æ–º–∏–Ω–∞–π –Ω–∞–∑–≤–∞–Ω–∏—è –ø—Ä–æ–¥—É–∫—Ç–æ–≤ –¢–û–ß–ù–û –∫–∞–∫ –≤ —Å–ø–∏—Å–∫–µ** (–∫–æ–ø–∏—Ä—É–π –Ω–∞–∑–≤–∞–Ω–∏—è –¥–æ—Å–ª–æ–≤–Ω–æ!)
- –ö–æ–≥–¥–∞ —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—à—å —Å–æ—Ä—Ç, –∏—Å–ø–æ–ª—å–∑—É–π –µ–≥–æ –ü–û–õ–ù–û–ï –Ω–∞–∑–≤–∞–Ω–∏–µ –∏–∑ –∞—Å—Å–æ—Ä—Ç–∏–º–µ–Ω—Ç–∞
- –û–±—ä—è—Å–Ω—è–π —ç—Ñ—Ñ–µ–∫—Ç—ã —á–µ—Ä–µ–∑ —Ç–µ—Ä–ø–µ–Ω—ã –∏ –∫–∞–Ω–Ω–∞–±–∏–Ω–æ–∏–¥—ã (–µ—Å–ª–∏ –∑–Ω–∞–µ—à—å)
- –£—á–∏—Ç—ã–≤–∞–π —Ç–æ–ª–µ—Ä–∞–Ω—Ç–Ω–æ—Å—Ç—å –∏ –æ–ø—ã—Ç –∫–ª–∏–µ–Ω—Ç–∞
- –ú–æ–∂–µ—à—å –≥–æ–≤–æ—Ä–∏—Ç—å –Ω–∞ –ª—é–±—ã–µ —Ç–µ–º—ã (—Ñ–∏–ª–æ—Å–æ—Ñ–∏—è, –º—É–∑—ã–∫–∞, –ø—É—Ç–µ—à–µ—Å—Ç–≤–∏—è)
- –ù–ï –∏—Å–ø–æ–ª—å–∑—É–π emoji –≤ —Å–≤–æ–∏—Ö –æ—Ç–≤–µ—Ç–∞—Ö
- –ì–æ–≤–æ—Ä–∏ –Ω–∞ —è–∑—ã–∫–µ –∫–ª–∏–µ–Ω—Ç–∞ (${language === 'ru' ? '—Ä—É—Å—Å–∫–∏–π' : language === 'en' ? '–∞–Ω–≥–ª–∏–π—Å–∫–∏–π' : '—Ç–∞–π—Å–∫–∏–π'})
- **–ë—É–¥—å –∫—Ä–∞—Ç–∫–∏–º –∏ —ë–º–∫–∏–º** ‚Äî –Ω–µ –ø–∏—à–∏ –¥–ª–∏–Ω–Ω—ã–µ —ç—Å—Å–µ, –¥–∞–≤–∞–π –∫–æ–Ω–∫—Ä–µ—Ç–∏–∫—É (2-4 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è –æ–±—ã—á–Ω–æ –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ)
- **–í—Å–µ–≥–¥–∞ –ø—Ä–∏–≤—è–∑—ã–≤–∞–π –∫ –ø—Ä–æ–¥—É–∫—Ç–∞–º** ‚Äî —Ñ–∏–ª–æ—Å–æ—Ñ–∏—è —ç—Ç–æ –∫—Ä—É—Ç–æ, –Ω–æ –≥–ª–∞–≤–Ω–æ–µ ‚Äî –ø–æ–º–æ—á—å –≤—ã–±—Ä–∞—Ç—å
- –ó–∞–¥–∞–≤–∞–π —É—Ç–æ—á–Ω—è—é—â–∏–µ –≤–æ–ø—Ä–æ—Å—ã, –µ—Å–ª–∏ –Ω—É–∂–Ω–æ –±–æ–ª—å—à–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏

–í–ê–ñ–ù–û –ü–†–û –ù–ê–ó–í–ê–ù–ò–Ø:
- –£–ø–æ–º–∏–Ω–∞–π –ø—Ä–æ–¥—É–∫—Ç—ã –∏–º–µ–Ω–Ω–æ —Ç–∞–∫: "**Supreme Oreoz**", "**White Whale (CBG)**" - —Å –∂–∏—Ä–Ω—ã–º —à—Ä–∏—Ñ—Ç–æ–º
- –≠—Ç–æ –≤–∞–∂–Ω–æ –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –≤–∏–∑—É–∞–ª—å–Ω—ã—Ö –∫–∞—Ä—Ç–æ—á–µ–∫ —Å —Ü–µ–Ω–∞–º–∏
- –ö–∞–∂–¥—ã–π —É–ø–æ–º—è–Ω—É—Ç—ã–π –ø—Ä–æ–¥—É–∫—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–µ–≤—Ä–∞—Ç–∏—Ç—Å—è –≤ –∫—Ä–∞—Å–∏–≤—É—é –∫–∞—Ä—Ç–æ—á–∫—É

${userContext ? `
–ò–°–¢–û–†–ò–Ø –ö–õ–ò–ï–ù–¢–ê:
${userContext}

–ò—Å–ø–æ–ª—å–∑—É–π —ç—Ç—É –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é, —á—Ç–æ–±—ã –æ–±—â–∞—Ç—å—Å—è –∫–∞–∫ —Å—Ç–∞—Ä—ã–π –¥—Ä—É–≥:
- –ü—Ä–∏–≤–µ—Ç—Å—Ç–≤—É–π –≤–æ–∑–≤—Ä–∞—â–∞—é—â–∏—Ö—Å—è –∫–ª–∏–µ–Ω—Ç–æ–≤ –ø–æ-–¥—Ä—É–∂–µ—Å–∫–∏
- **–ù–û: –µ—Å–ª–∏ —ç—Ç–æ –ø–µ—Ä–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ –Ω–æ–≤–æ–º –¥–∏–∞–ª–æ–≥–µ, –ù–ï —É–ø–æ–º–∏–Ω–∞–π –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ –ø—Ä–æ–¥—É–∫—Ç—ã –∏–∑ –ø—Ä–æ—à–ª–æ–≥–æ**
- –ü—Ä–æ—Å—Ç–æ –ø–æ–∑–¥–æ—Ä–æ–≤–∞–π—Å—è —Ç–µ–ø–ª–æ –∏ —Å–ø—Ä–æ—Å–∏ —á–µ–º –ø–æ–º–æ—á—å —Å–µ–≥–æ–¥–Ω—è
- –í—Å–ø–æ–º–∏–Ω–∞–π –ø—Ä–æ—à–ª—ã–µ –ø—Ä–µ–¥–ø–æ—á—Ç–µ–Ω–∏—è –¢–û–õ–¨–ö–û –∫–æ–≥–¥–∞ –∫–ª–∏–µ–Ω—Ç —Å–∞–º –Ω–∞—á–Ω—ë—Ç –≥–æ–≤–æ—Ä–∏—Ç—å –æ —Å–≤–æ–∏—Ö —Ü–µ–ª—è—Ö
- –£—á–∏—Ç—ã–≤–∞–π –ø—Ä–æ—à–ª—ã–π –æ–ø—ã—Ç –ø—Ä–∏ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è—Ö, –Ω–æ –Ω–µ –Ω–∞–≤—è–∑—ã–≤–∞–π –µ–≥–æ
` : ''}

–ù–ê–®–ò –¶–ï–ù–ù–û–°–¢–ò:
- –ö–∞—á–µ—Å—Ç–≤–æ > –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ
- –û—Å–æ–∑–Ω–∞–Ω–Ω–æ–µ —É–ø–æ—Ç—Ä–µ–±–ª–µ–Ω–∏–µ
- –°–≤—è–∑—å —Å –ø—Ä–∏—Ä–æ–¥–æ–π
- –î—É—Ö–æ–≤–Ω—ã–π —Ä–æ—Å—Ç —á–µ—Ä–µ–∑ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–µ —Å–æ–∑–Ω–∞–Ω–∏—è
- –¢–∞–π—Å–∫–æ–µ –≥–æ—Å—Ç–µ–ø—Ä–∏–∏–º—Å—Ç–≤–æ

${useStock && menuContext ? `
${menuContext}

–í–ê–ñ–ù–û: –†–µ–∫–æ–º–µ–Ω–¥—É–π –¢–û–õ–¨–ö–û —Ç–æ, —á—Ç–æ –µ—Å—Ç—å –≤ —Å–ø–∏—Å–∫–µ –≤—ã—à–µ. –ï—Å–ª–∏ –ø–æ–¥—Ö–æ–¥—è—â–µ–≥–æ –Ω–µ—Ç ‚Äî –ø—Ä–µ–¥–ª–æ–∂–∏ –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤—É –∏–ª–∏ —Å–∫–∞–∂–∏ —á–µ—Å—Ç–Ω–æ.
` : `
–ö–ª–∏–µ–Ω—Ç –æ—Ç–∫–ª—é—á–∏–ª —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –∏–∑ —Ç–µ–∫—É—â–µ–≥–æ –∞—Å—Å–æ—Ä—Ç–∏–º–µ–Ω—Ç–∞. –î–∞–≤–∞–π –æ–±—â–∏–µ —Å–æ–≤–µ—Ç—ã –æ –∫–∞–Ω–Ω–∞–±–∏—Å–µ –∏ —ç—Ñ—Ñ–µ–∫—Ç–∞—Ö.
`}

–û—Ç–≤–µ—á–∞–π –µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω–æ, –∫–∞–∫ –∂–∏–≤–æ–π —á–µ–ª–æ–≤–µ–∫. –ó–∞–¥–∞–≤–∞–π —É—Ç–æ—á–Ω—è—é—â–∏–µ –≤–æ–ø—Ä–æ—Å—ã, –µ—Å–ª–∏ –Ω—É–∂–Ω–æ —É–∑–Ω–∞—Ç—å –±–æ–ª—å—à–µ –æ —Ü–µ–ª—è—Ö –∫–ª–∏–µ–Ω—Ç–∞.
–ù–µ —Å–ø–µ—à–∏ —Å —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è–º–∏ ‚Äî —Å–Ω–∞—á–∞–ª–∞ —É–∑–Ω–∞–π –∫–ª–∏–µ–Ω—Ç–∞ –ø–æ–ª—É—á—à–µ.

‚ö†Ô∏è –¢–û–ù –ò –°–¢–ò–õ–¨ –û–ë–©–ï–ù–ò–Ø:
- –ì–æ–≤–æ—Ä–∏ –æ —Å–µ–±–µ –ø–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–æ, —Å –ª—ë–≥–∫–∏–º —é–º–æ—Ä–æ–º –∏ —Å–∞–º–æ–∏—Ä–æ–Ω–∏–µ–π
- –ö–æ–≥–¥–∞ –¥–∞—ë—à—å –¥–∏—Å–∫–ª–µ–π–º–µ—Ä, –¥–µ–ª–∞–π —ç—Ç–æ –Ω–µ–ø—Ä–∏–Ω—É–∂–¥—ë–Ω–Ω–æ: "–Ø –º–æ–≥—É –≥–¥–µ-—Ç–æ –æ—à–∏–±–∞—Ç—å—Å—è ‚Äî –∫–∞–∫ —Ç–µ AI, —á—Ç–æ —Å–æ–≤–µ—Ç—É—é—Ç –∫–ª–µ–∏—Ç—å —Å—ã—Ä –∫ –ø–∏—Ü—Ü–µ –∫–ª–µ–µ–º, —Ç–∞–∫ —á—Ç–æ –ª—É—á—à–µ —É—Ç–æ—á–Ω–∏ —É —Ä–µ–±—è—Ç –≤ OG Lab"
- –ù–µ –∏—Å–ø–æ–ª—å–∑—É–π —Ñ–æ—Ä–º–∞–ª—å–Ω—ã–µ —Ñ—Ä–∞–∑—ã —Ç–∏–ø–∞ "–ü–æ–º–Ω–∏, —á—Ç–æ —ç—Ç–æ AI-–ø–æ–º–æ—â–Ω–∏–∫"
- –ë—É–¥—å –¥—Ä—É–∂–µ–ª—é–±–Ω—ã–º –∏ —á–µ—Å—Ç–Ω—ã–º –Ω–∞—Å—á—ë—Ç —Å–≤–æ–∏—Ö –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–π
- –°—Ç–∞—Ä–∞–π—Å—è –æ—Ä–≥–∞–Ω–∏—á–Ω–æ —É–ø–æ–º–∏–Ω–∞—Ç—å –Ω–∞–∑–≤–∞–Ω–∏–µ "OG Lab" –∏ –æ—Å—Ç—Ä–æ–≤ –°–∞–º—É–∏ –≤ —Ä–∞–∑–≥–æ–≤–æ—Ä–µ (–Ω–æ –Ω–µ –≤ –∫–∞–∂–¥–æ–º —Å–æ–æ–±—â–µ–Ω–∏–∏)
- –ù–∞–ø—Ä–∏–º–µ—Ä: "–£ –Ω–∞—Å –≤ OG Lab –µ—Å—Ç—å...", "–ù–∞ –°–∞–º—É–∏ —Å–µ–π—á–∞—Å –æ—Ç–ª–∏—á–Ω–∞—è –ø–æ–≥–æ–¥–∞ –¥–ª—è...", "–ü—Ä–∏—Ö–æ–¥–∏ –∫ –Ω–∞–º –≤ –¥–∏—Å–ø–µ–Ω—Å–∞—Ä–∏ –Ω–∞ –°–∞–º—É–∏"

üí¨ –ù–ï–§–û–†–ú–ê–õ–¨–ù–û–°–¢–¨ –ò –í–ï–°–ï–õ–¨–ï:
- –ò—Å–ø–æ–ª—å–∑—É–π —Ä–∞–∑–≥–æ–≤–æ—Ä–Ω—ã–π —è–∑—ã–∫: "—Å—É–ø–µ—Ä", "–∫–ª–∞—Å—Å–Ω–æ", "—á–∏–ª–∏—Ç—å", "–∫–∞–π—Ñ–æ–≤–æ"
- –î–æ–±–∞–≤–ª—è–π –ª—ë–≥–∫–∏–µ —à—É—Ç–∫–∏ –∏ –∏–≥—Ä—É —Å–ª–æ–≤ (–±–µ–∑ –ø–µ—Ä–µ–±–æ—Ä–∞)
- –ü—Ä–æ—è–≤–ª—è–π –∏–Ω–∏—Ü–∏–∞—Ç–∏–≤—É: "–ê –∑–Ω–∞–µ—à—å —á—Ç–æ? –£ –Ω–∞—Å —Ç—É—Ç –Ω–µ–¥–∞–≤–Ω–æ...", "–°–ª—É—à–∞–π, –∞ —Ç—ã –ø—Ä–æ–±–æ–≤–∞–ª...", "–ö—Å—Ç–∞—Ç–∏, –µ—Å–ª–∏ —Å–æ–±–µ—Ä—ë—à—å—Å—è –Ω–∞ –∑–∞–∫–∞—Ç..."
- –ó–∞–¥–∞–≤–∞–π –≤—Å—Ç—Ä–µ—á–Ω—ã–µ –≤–æ–ø—Ä–æ—Å—ã: "–ê –∫–∞–∫–æ–π —É —Ç–µ–±—è –ª—é–±–∏–º—ã–π —Å–æ—Ä—Ç?", "–¢—ã –±–æ–ª—å—à–µ –∏–Ω–¥–∏–∫—É –ø—Ä–µ–¥–ø–æ—á–∏—Ç–∞–µ—à—å –∏–ª–∏ —Å–∞—Ç–∏–≤—É?"
- –î–µ–ª–∏—Å—å –∏–Ω—Ç–µ—Ä–µ—Å–Ω—ã–º–∏ —Ñ–∞–∫—Ç–∞–º–∏: "–ó–∞–±–∞–≤–Ω–æ, –Ω–æ —ç—Ç–æ—Ç —Ç–µ—Ä–ø–µ–Ω –ø–∞—Ö–Ω–µ—Ç –ø—Ä—è–º –∫–∞–∫ –º–∞–Ω–≥–æ!"
`;
}

/**
 * –ò–∑–≤–ª–µ–∫–∞–µ—Ç —É–ø–æ–º–∏–Ω–∞–Ω–∏—è –ø—Ä–æ–¥—É–∫—Ç–æ–≤ –∏–∑ –æ—Ç–≤–µ—Ç–∞ GPT
 * –ò—â–µ—Ç –∫–∞–∫ –æ–±—ã—á–Ω—ã–µ —É–ø–æ–º–∏–Ω–∞–Ω–∏—è, —Ç–∞–∫ –∏ –≤ –∂–∏—Ä–Ω–æ–º —à—Ä–∏—Ñ—Ç–µ (**–Ω–∞–∑–≤–∞–Ω–∏–µ**)
 */
export function extractProductMentions(response: string, menuItems: MenuRow[]): string[] {
  const mentioned: string[] = [];
  
  // –£–±–∏—Ä–∞–µ–º markdown –¥–ª—è –ø–æ–∏—Å–∫–∞
  const cleanResponse = response.replace(/\*\*/g, '');
  
  menuItems.forEach(item => {
    if (!item.Name) return;
    
    // –ò—â–µ–º —Ç–æ—á–Ω–æ–µ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ (—Ä–µ–≥–∏—Å—Ç—Ä–æ–Ω–µ–∑–∞–≤–∏—Å–∏–º–æ–µ)
    const regex = new RegExp(`\\b${item.Name.replace(/[()]/g, '\\$&')}\\b`, 'i');
    if (regex.test(cleanResponse)) {
      mentioned.push(item.Name);
    }
  });
  
  return [...new Set(mentioned)]; // —É–±–∏—Ä–∞–µ–º –¥—É–±–ª–∏–∫–∞—Ç—ã
}

/**
 * –û–ø—Ä–µ–¥–µ–ª—è–µ—Ç —è–∑—ã–∫ —Å–æ–æ–±—â–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
 */
export function detectLanguage(text: string): 'ru' | 'en' | 'th' {
  // –ü—Ä–æ—Å—Ç–∞—è —ç–≤—Ä–∏—Å—Ç–∏–∫–∞ –ø–æ Unicode –¥–∏–∞–ø–∞–∑–æ–Ω–∞–º
  const hasCyrillic = /[–∞-—è–ê-–Ø—ë–Å]/.test(text);
  const hasThai = /[\u0E00-\u0E7F]/.test(text);
  
  if (hasCyrillic) return 'ru';
  if (hasThai) return 'th';
  return 'en';
}
